{{- define "main" -}}
<section class="container my-5">
  <header class="mb-5">
    <h1>{{ .Title }}</h1>
    {{- with .Content -}}
      <div class="text-muted">
        {{ . }}
      </div>
    {{- end -}}
  </header>

  {{- $quotes := .Site.Data.socialproof.quotes -}}
  {{- $category := .Params.category -}}
  {{- if $category -}}
    {{- $quotes = where $quotes "category" $category -}}
  {{- end -}}
  {{- $sortedQuotes := sort $quotes "date" "desc" -}}

  <nav class="d-flex justify-content-start gap-2 mb-4 flex-wrap">
    <a href="/social-proof/" class="btn btn-sm {{- if not $category }}btn-primary{{- else }}btn-outline-primary{{- end }}">All ({{ len .Site.Data.socialproof.quotes }})</a>
    <a href="/social-proof/consulting/" class="btn btn-sm {{- if eq $category "consulting" }}btn-primary{{- else }}btn-outline-primary{{- end }}">Consulting ({{ len (where .Site.Data.socialproof.quotes "category" "consulting") }})</a>
    <a href="/social-proof/training/" class="btn btn-sm {{- if eq $category "training" }}btn-primary{{- else }}btn-outline-primary{{- end }}">Training ({{ len (where .Site.Data.socialproof.quotes "category" "training") }})</a>
  </nav>

  <div class="text-muted mb-4" style="font-size: 0.9rem;">
    <p id="pagination-info">Showing <span id="showing-count">0</span> of {{ len $sortedQuotes }} testimonials</p>
  </div>

  <div id="quotes-container">
    {{- range $sortedQuotes -}}
      <div class="testimonial mb-4 pb-4 border-bottom" data-id="{{ .id }}">
        <blockquote class="mb-3">
          <p>{{ .text }}</p>
        </blockquote>
        <footer>
          <cite class="text-body not-italic">
            <strong>{{ .name }}</strong>
            {{- with .title }}{{ if ne . "" }}<br><span class="text-muted" style="font-size: 0.9rem;">{{ . }}</span>{{ end }}{{ end -}}
          </cite>
          <div class="d-flex flex-wrap gap-2 align-items-center mt-2" style="font-size: 0.9rem;">
            {{- with .relationship }}<span class="badge bg-primary-subtle text-primary">{{ . }}</span>{{ end -}}
            {{- with .class }}<span class="badge bg-warning-subtle text-warning">{{ . | upper }}</span>{{ end -}}
            {{- with .stars }}<span class="text-warning">{{ range seq . }}⭐{{ end }}</span>{{ end -}}
            {{- with .date }}<time datetime="{{ . }}" class="text-muted">{{ dateFormat "2 Jan 2006" . }}</time>{{ end -}}
          </div>
        </footer>
      </div>
    {{- end -}}
  </div>

  <nav class="d-flex justify-content-center gap-2 mt-5 flex-wrap" id="pagination-nav" aria-label="Testimonials pagination"></nav>
</section>

<script>
(function() {
  const itemsPerPage = 20;
  let currentPage = 1;
  const container = document.getElementById('quotes-container');
  const allTestimonials = Array.from(container.querySelectorAll('.testimonial'));
  const totalPages = Math.ceil(allTestimonials.length / itemsPerPage);

  function showPage(page) {
    currentPage = page;
    const start = (page - 1) * itemsPerPage;
    const end = start + itemsPerPage;

    allTestimonials.forEach((testimonial, index) => {
      if (index >= start && index < end) {
        testimonial.style.display = 'block';
      } else {
        testimonial.style.display = 'none';
      }
    });

    document.getElementById('showing-count').textContent = 
      Math.min(end, allTestimonials.length);

    renderPagination();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function renderPagination() {
    const nav = document.getElementById('pagination-nav');
    nav.innerHTML = '';

    // Previous button
    if (currentPage > 1) {
      const prev = document.createElement('a');
      prev.href = '#';
      prev.className = 'btn btn-sm btn-outline-primary';
      prev.textContent = '← Previous';
      prev.onclick = (e) => {
        e.preventDefault();
        showPage(currentPage - 1);
      };
      nav.appendChild(prev);
    }

    // Page numbers
    const maxVisible = 7;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);
    
    if (endPage - startPage < maxVisible - 1) {
      startPage = Math.max(1, endPage - maxVisible + 1);
    }

    if (startPage > 1) {
      const first = document.createElement('a');
      first.href = '#';
      first.className = 'btn btn-sm btn-outline-primary';
      first.textContent = '1';
      first.onclick = (e) => {
        e.preventDefault();
        showPage(1);
      };
      nav.appendChild(first);

      if (startPage > 2) {
        const ellipsis = document.createElement('span');
        ellipsis.className = 'btn btn-sm btn-outline-secondary disabled';
        ellipsis.textContent = '...';
        nav.appendChild(ellipsis);
      }
    }

    for (let i = startPage; i <= endPage; i++) {
      const pageLink = document.createElement(i === currentPage ? 'span' : 'a');
      pageLink.href = '#';
      pageLink.className = i === currentPage ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-outline-primary';
      pageLink.textContent = i;
      if (i !== currentPage) {
        pageLink.onclick = (e) => {
          e.preventDefault();
          showPage(i);
        };
      }
      nav.appendChild(pageLink);
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        const ellipsis = document.createElement('span');
        ellipsis.className = 'btn btn-sm btn-outline-secondary disabled';
        ellipsis.textContent = '...';
        nav.appendChild(ellipsis);
      }

      const last = document.createElement('a');
      last.href = '#';
      last.className = 'btn btn-sm btn-outline-primary';
      last.textContent = totalPages;
      last.onclick = (e) => {
        e.preventDefault();
        showPage(totalPages);
      };
      nav.appendChild(last);
    }

    // Next button
    if (currentPage < totalPages) {
      const next = document.createElement('a');
      next.href = '#';
      next.className = 'btn btn-sm btn-outline-primary';
      next.textContent = 'Next →';
      next.onclick = (e) => {
        e.preventDefault();
        showPage(currentPage + 1);
      };
      nav.appendChild(next);
    }
  }

  // Initialize
  showPage(1);
})();
</script>

{{- end -}}
