{{- $section := .section -}}
{{- $relatedToPath := .relatedToPath -}}
{{- $currentPage := .currentPage -}}
{{- $relatedItems := slice -}}
{{- $seenPaths := slice -}}

{{- /* Forward lookup: Check current page's related array for items in target section */ -}}
{{- if $currentPage -}}
  {{- if $currentPage.Params.related -}}
    {{- range $currentPage.Params.related -}}
      {{- $relatedPath := . -}}
      {{- if not (hasPrefix $relatedPath "/") -}}
        {{- $relatedPath = printf "/%s" $relatedPath -}}
      {{- end -}}
      {{- if not (hasSuffix $relatedPath "/") -}}
        {{- $relatedPath = printf "%s/" $relatedPath -}}
      {{- end -}}
      {{- $foundPage := site.GetPage $relatedPath -}}
      {{- if $foundPage -}}
        {{- if eq $foundPage.Section $section -}}
          {{- $relatedItems = $relatedItems | append $foundPage -}}
          {{- $seenPaths = $seenPaths | append $foundPage.RelPermalink -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Reverse lookup: Find items in target section that list current page in their related array */ -}}
{{- range where site.RegularPages "Section" $section -}}
  {{- $item := . -}}
  {{- $isPublished := le .Date now -}}
  {{- $showDrafts := or (eq hugo.Environment "preview") (eq hugo.Environment "development") -}}
  {{- if or $isPublished $showDrafts -}}
    {{- if $item.Params.related -}}
      {{- range $item.Params.related -}}
        {{- $relatedPath := . -}}
        {{- if not (hasPrefix $relatedPath "/") -}}
          {{- $relatedPath = printf "/%s" $relatedPath -}}
        {{- end -}}
        {{- if not (hasSuffix $relatedPath "/") -}}
          {{- $relatedPath = printf "%s/" $relatedPath -}}
        {{- end -}}
        {{- if eq $relatedPath $relatedToPath -}}
          {{- if not (in $seenPaths $item.RelPermalink) -}}
            {{- $relatedItems = $relatedItems | append $item -}}
            {{- $seenPaths = $seenPaths | append $item.RelPermalink -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- return $relatedItems -}}
