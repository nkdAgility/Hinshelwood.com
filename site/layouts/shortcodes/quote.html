{{- $id := .Get "id" -}}
{{- $name := .Get "name" -}}
{{- $date := .Get "date" -}}
{{- $relationship := .Get "relationship" -}}
{{- $class := .Get "class" -}}
{{- $truncate := .Get "truncate" | default "" -}}
{{- $limit := 50 -}}
{{- if $truncate -}}
  {{- $limit = int $truncate -}}
{{- end -}}

{{- $quote := "" -}}

{{- if $id -}}
  {{- $quote = index (where $.Site.Data.socialproof.quotes "id" $id) 0 -}}
{{- else if and $name $date -}}
  {{- range $.Site.Data.socialproof.quotes -}}
    {{- if and (eq .name $name) (eq .date $date) -}}
      {{- $quote = . -}}
    {{- end -}}
  {{- end -}}
{{- else if and $name $relationship -}}
  {{- range $.Site.Data.socialproof.quotes -}}
    {{- if and (eq .name $name) (eq .relationship $relationship) -}}
      {{- $quote = . -}}
    {{- end -}}
  {{- end -}}
{{- else if and $name $class -}}
  {{- range $.Site.Data.socialproof.quotes -}}
    {{- if and (eq .name $name) (eq .class $class) -}}
      {{- $quote = . -}}
    {{- end -}}
  {{- end -}}
{{- else if $name -}}
  {{- $quote = index (where $.Site.Data.socialproof.quotes "name" $name) 0 -}}
{{- end -}}

{{- with $quote -}}
  {{- $displayText := .text -}}
  {{- $isTruncated := false -}}
  {{- if $truncate -}}
    {{- $truncateResult := partial "functions/truncate-text.html" (dict "text" .text "limit" $limit) -}}
    {{- $displayText = $truncateResult.text -}}
    {{- $isTruncated = $truncateResult.truncated -}}
  {{- end -}}
<blockquote class="social-proof">
  <p>
    <span class="quote-text">{{ $displayText }}{{ if $isTruncated }}...{{ end }}</span>
    {{- if $isTruncated }}
      <button class="btn btn-link btn-sm p-0 ms-1 text-decoration-none quote-toggle" 
              data-full-text="{{ .text | htmlEscape }}"
              data-short-text="{{ $displayText | htmlEscape }}"
              aria-label="Expand quote">more...</button>
    {{- end }}
  </p>
  <footer>
    <cite>
      <strong>{{ .name }}</strong>
      {{- with .title }}{{ if ne . "" }} - {{ . }}{{ end }}{{ end -}}
      {{- with .relationship }} ({{ . }}){{ end -}}
      {{- with .class }} - {{ . | upper }}{{ end -}}
      {{- with .stars }} - {{ range seq . }}‚≠ê{{ end }}{{ end -}}
    </cite>
  </footer>
</blockquote>
<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.quote-toggle').forEach(function(btn) {
    let expanded = false;
    const fullText = btn.getAttribute('data-full-text');
    const shortText = btn.getAttribute('data-short-text');
    const textSpan = btn.previousElementSibling;
    
    btn.addEventListener('click', function() {
      expanded = !expanded;
      if (expanded) {
        textSpan.textContent = fullText;
        btn.textContent = 'less';
      } else {
        textSpan.textContent = shortText + '...';
        btn.textContent = 'more...';
      }
    });
  });
});
</script>
{{- else -}}
<p><em>Quote not found</em></p>
{{- end -}}
